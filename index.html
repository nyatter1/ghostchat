<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ghost Chat</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts (Broad Selection) -->
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Anton&family=Arimo&family=Bangers&family=Bitter&family=Bree+Serif&family=Bungee&family=Butcherman&family=Cabin&family=Caveat&family=Comfortaa&family=Concert+One&family=Creepster&family=Dancing+Script&family=Dosis&family=Eater&family=Fira+Sans&family=Fjalla+One&family=Fredoka+One&family=Frijole&family=Gloria+Hallelujah&family=Great+Vibes&family=Inconsolata&family=Indie+Flower&family=Kalam&family=Kanit&family=Lato&family=Lobster&family=Lora&family=Merriweather&family=Monoton&family=Montserrat&family=Mukta&family=Nosifer&family=Noto+Sans&family=Nunito&family=Open+Sans&family=Orbitron&family=Oswald&family=Oxygen&family=Pacifico&family=Permanent+Marker&family=Playfair+Display&family=Poppins&family=Press+Start+2P&family=Prompt&family=PT+Sans&family=Quicksand&family=Raleway&family=Righteous&family=Roboto&family=Rubik&family=Ruslan+Display&family=Sacramento&family=Shadows+Into+Light&family=Special+Elite&family=Ubuntu&family=Varela+Round&family=Work+Sans&family=Zilla+Slab&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            animation: {
              'float': 'float 6s ease-in-out infinite',
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'glow': 'glow 2s ease-in-out infinite alternate',
              'spin-fast': 'spin 0.7s linear infinite',
              'fade-in': 'fadeIn 0.5s ease-out forwards',
              'jump-in': 'jumpIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
              'pop': 'pop 0.3s ease-out forwards',
              'heart-beat': 'heartBeat 0.3s ease-in-out',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-20px)' },
              },
              glow: {
                'from': { boxShadow: '0 0 10px #a855f7, 0 0 20px #a855f7' },
                'to': { boxShadow: '0 0 20px #ec4899, 0 0 30px #ec4899' },
              },
              fadeIn: {
                'from': { opacity: '0', transform: 'translateY(10px)' },
                'to': { opacity: '1', transform: 'translateY(0)' },
              },
              jumpIn: {
                '0%': { opacity: '0', transform: 'scale(0.3) translateY(100px)' },
                '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
              },
              pop: {
                '0%': { transform: 'scale(0.95)' },
                '50%': { transform: 'scale(1.05)' },
                '100%': { transform: 'scale(1)' },
              },
              heartBeat: {
                '0%': { transform: 'scale(1)' },
                '50%': { transform: 'scale(1.3)' },
                '100%': { transform: 'scale(1)' },
              }
            }
          },
        },
      }
    </script>
    <style>
      body {
        background-color: #020617; /* slate-950 */
        color: #f8fafc; /* slate-50 */
        overflow-x: hidden;
        margin: 0;
        font-family: 'Inter', sans-serif;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: background 0.3s ease, border-color 0.3s ease;
      }
      /* Transitions for height/opacity */
      .form-group {
        transition: all 0.3s ease-in-out;
        overflow: hidden;
      }
      .hidden-group {
        max-height: 0;
        opacity: 0;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }
      .visible-group {
        max-height: 100px; /* Arbitrary max-height for transition */
        opacity: 1;
      }
      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(100, 116, 139, 0.5);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.8);
      }
      
      /* Dropdown Animation */
      .dropdown-enter {
        transform: scale(0.95);
        opacity: 0;
      }
      .dropdown-enter-active {
        transform: scale(1);
        opacity: 1;
        transition: all 0.1s ease-out;
      }
      .dropdown-exit {
        transform: scale(1);
        opacity: 1;
      }
      .dropdown-exit-active {
        transform: scale(0.95);
        opacity: 0;
        transition: all 0.1s ease-in;
      }

      /* Modal Blur */
      .modal-overlay {
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        background: rgba(2, 6, 23, 0.6);
      }
      
      /* File Input Hidden */
      .file-input-hidden {
        display: none;
      }

      /* Lightbox */
      .lightbox-open #lightbox-img {
        transform: scale(1);
      }

      /* Canvas specific */
      #paint-canvas {
        cursor: crosshair;
        touch-action: none;
      }
      input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
      }
      input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 50%;
      }
      
      /* Text & FX Studio Styles */
      .ts-grid-item {
         transition: all 0.2s;
         cursor: pointer;
         border: 1px solid rgba(255,255,255,0.1);
      }
      .ts-grid-item:hover {
         transform: scale(1.1);
         z-index: 10;
         box-shadow: 0 0 15px rgba(255,255,255,0.2);
         border-color: rgba(255,255,255,0.5);
      }
      .ts-selected {
         box-shadow: 0 0 0 2px #fff, 0 0 10px #a855f7;
         transform: scale(1.1);
         border-color: transparent;
      }
      .ts-font-item {
         padding: 8px;
         cursor: pointer;
         border-radius: 6px;
         transition: background-color 0.2s;
      }
      .ts-font-item:hover {
         background-color: rgba(255,255,255,0.1);
      }
      .ts-font-selected {
         background-color: rgba(99, 102, 241, 0.3);
         color: #fff;
      }
    </style>
  </head>
  <body>
    <!-- Hidden File Inputs -->
    <input type="file" id="file-input-avatar" accept="image/*" class="file-input-hidden">
    <input type="file" id="file-input-banner" accept="image/*" class="file-input-hidden">
    <!-- New Chat Image Input -->
    <input type="file" id="file-input-chat" accept="image/*" class="file-input-hidden">

    <!-- Dynamic Background Elements (Visible on Login) -->
    <div id="bg-elements" class="fixed inset-0 z-0 pointer-events-none transition-opacity duration-1000">
      <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-900/30 rounded-full blur-[120px] animate-pulse-slow"></div>
      <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-indigo-900/20 rounded-full blur-[120px] animate-pulse-slow" style="animation-delay: 2s"></div>
      <div class="absolute top-[20%] right-[20%] w-[300px] h-[300px] bg-cyan-900/20 rounded-full blur-[100px] animate-float"></div>
    </div>

    <!-- LIGHTBOX (Full Screen Image Viewer) -->
    <div id="lightbox" class="fixed inset-0 z-[100] bg-black/95 hidden flex items-center justify-center cursor-pointer opacity-0 transition-opacity duration-300">
       <div class="absolute top-4 right-4 text-white/50 hover:text-white">
         <i data-lucide="x" class="w-8 h-8"></i>
       </div>
       <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain p-4 transition-transform duration-300 scale-90">
    </div>

    <div class="relative min-h-screen w-full flex items-center justify-center">
      
      <!-- AUTH CONTAINER -->
      <div id="auth-container" class="relative z-10 w-full max-w-md p-6">
        <div class="glass-panel rounded-2xl shadow-2xl p-8 transform transition-all duration-500 hover:shadow-purple-500/10 hover:border-white/20">
          
          <!-- Header -->
          <div class="flex flex-col items-center mb-10">
            <div class="bg-gradient-to-tr from-indigo-500 to-purple-500 p-4 rounded-full mb-4 shadow-lg shadow-purple-500/30 animate-float">
              <i data-lucide="ghost" class="w-10 h-10 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 tracking-tight">
              Ghost Chat
            </h1>
            <p id="header-subtitle" class="text-slate-400 text-sm mt-2 font-light">
              Welcome back to the void.
            </p>
          </div>

          <!-- Error Message -->
          <div id="auth-error" class="hidden mb-4 p-3 rounded-lg bg-red-900/40 border border-red-500/50 text-red-200 text-sm text-center">
          </div>

          <!-- Form -->
          <form id="auth-form" class="space-y-5">
            
            <!-- Username Input (Hidden by default for Login) -->
            <div id="username-container" class="form-group hidden-group">
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                  <i data-lucide="user" class="w-5 h-5"></i>
                </div>
                <input
                  type="text"
                  id="username"
                  placeholder="Soul Name"
                  class="block w-full pl-10 pr-3 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Email Input -->
            <div class="group">
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                  <i data-lucide="mail" class="w-5 h-5"></i>
                </div>
                <input
                  type="email"
                  id="email"
                  required
                  placeholder="Spectral Email"
                  class="block w-full pl-10 pr-3 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Password Input -->
            <div class="group">
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                  <i data-lucide="lock" class="w-5 h-5"></i>
                </div>
                <input
                  type="password"
                  id="password"
                  required
                  placeholder="Secret Glyph"
                  class="block w-full pl-10 pr-3 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="submit-btn"
              class="w-full relative overflow-hidden group bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-semibold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-purple-900/20"
            >
              <div class="absolute inset-0 w-full h-full bg-white/20 group-hover:translate-x-full transition-transform duration-500 -skew-x-12 -translate-x-full"></div>
              <span class="relative flex items-center justify-center gap-2">
                <!-- Loader Icon (Hidden by default) -->
                <i id="btn-loader" data-lucide="zap" class="w-5 h-5 animate-spin-fast hidden"></i>
                
                <!-- Text & Arrow -->
                <span id="btn-text">Resurrect</span>
                <i id="btn-icon" data-lucide="arrow-right" class="w-4 h-4"></i>
              </span>
            </button>
          </form>

          <!-- Footer / Toggle -->
          <div class="mt-8 text-center">
            <p class="text-slate-500 text-sm">
              <span id="toggle-text-prompt">Don't have a vessel?</span>
              <button
                id="toggle-btn"
                class="ml-2 text-purple-400 hover:text-purple-300 font-medium transition-colors hover:underline decoration-purple-500/30 underline-offset-4"
              >
                Create Account
              </button>
            </p>
          </div>
        </div>

        <!-- Decorative footer text -->
        <div class="text-center mt-6 opacity-30 text-xs text-slate-500 font-mono">
          EST. 2024 â€¢ THE VOID
        </div>
      </div>
    </div>

    <!-- CHAT CONTAINER (Full Screen) -->
    <div id="chat-container" class="hidden fixed inset-0 z-50 w-full h-full bg-slate-950 flex flex-row overflow-hidden">
      
      <!-- Left Column: Chat Area -->
      <div class="flex-1 flex flex-col relative h-full">
        <!-- Chat Header -->
        <div class="h-16 px-6 border-b border-white/5 bg-slate-900/50 backdrop-blur-xl flex items-center justify-between z-20 shrink-0">
          <div class="flex items-center gap-3">
             <i data-lucide="hash" class="w-6 h-6 text-slate-400"></i>
             <h2 class="font-bold text-slate-100 text-lg tracking-tight">general-void</h2>
          </div>
          
          <!-- User Profile & Dropdown -->
          <div class="relative" id="profile-container">
            <button id="profile-btn" class="flex items-center justify-center w-10 h-10 rounded-full bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-500/30 text-indigo-200 transition-all active:scale-95 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 overflow-hidden">
               <img id="header-avatar-img" src="" alt="Avatar" class="w-full h-full object-cover hidden">
               <span id="profile-initial" class="font-bold text-sm">G</span>
            </button>
            
            <!-- Dropdown Menu -->
            <div id="profile-dropdown" class="hidden absolute right-0 mt-3 w-48 rounded-xl glass-panel shadow-2xl border border-white/10 overflow-hidden transform origin-top-right transition-all duration-200 z-50">
               <div class="p-2 space-y-1">
                 <button id="wallet-btn" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-colors text-left">
                   <i data-lucide="wallet" class="w-4 h-4 text-emerald-400"></i>
                   Wallet
                 </button>
                 <button id="my-profile-btn" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-colors text-left">
                   <i data-lucide="user" class="w-4 h-4 text-indigo-400"></i>
                   My Profile
                 </button>
                 <div class="h-px bg-white/10 my-1 mx-2"></div>
                 <button id="logout-btn" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition-colors text-left">
                   <i data-lucide="log-out" class="w-4 h-4"></i>
                   Logout
                 </button>
               </div>
            </div>
          </div>

        </div>

        <!-- Messages Area -->
        <div id="messages-list" class="flex-1 overflow-y-auto px-4 py-6 scroll-smooth space-y-2">
           <!-- Empty State -->
           <div id="empty-state" class="flex flex-col items-center justify-center mt-20 text-slate-600">
               <i data-lucide="wind" class="w-12 h-12 mb-4 opacity-50"></i>
               <p>The void is empty. Start a conversation.</p>
           </div>
        </div>

        <!-- Input Area -->
        <div class="p-6 bg-slate-900/50 shrink-0 relative">
          
          <form id="message-form" class="relative">
            
            <!-- Plus Menu Popup -->
            <div id="plus-menu" class="absolute bottom-full left-4 mb-3 flex flex-col gap-3 transition-all duration-300 transform translate-y-4 opacity-0 pointer-events-none z-10">
               <!-- Paint -->
               <button type="button" id="paint-btn" class="w-10 h-10 rounded-full bg-indigo-600 hover:bg-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-500/30 transition-all hover:scale-110 active:scale-95 group">
                 <i data-lucide="palette" class="w-5 h-5"></i>
                 <span class="absolute left-12 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Paint</span>
               </button>
               <!-- ABC (Text Studio) -->
               <button type="button" id="text-studio-btn" class="w-10 h-10 rounded-full bg-pink-600 hover:bg-pink-500 text-white flex items-center justify-center shadow-lg shadow-pink-500/30 transition-all hover:scale-110 active:scale-95 group">
                 <i data-lucide="type" class="w-5 h-5"></i>
                 <span class="absolute left-12 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Text</span>
               </button>
               <!-- FX Studio (Cards) -->
               <button type="button" id="fx-studio-btn" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-500 text-white flex items-center justify-center shadow-lg shadow-violet-500/30 transition-all hover:scale-110 active:scale-95 group">
                 <i data-lucide="sparkles" class="w-5 h-5"></i>
                 <span class="absolute left-12 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">FX</span>
               </button>
               <!-- Upload -->
               <button type="button" id="chat-upload-btn" class="w-10 h-10 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-500/30 transition-all hover:scale-110 active:scale-95 group">
                 <i data-lucide="image" class="w-5 h-5"></i>
                 <span class="absolute left-12 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Upload</span>
               </button>
            </div>

            <!-- Plus Button Trigger -->
            <div class="absolute inset-y-0 left-0 pl-2 flex items-center">
               <button type="button" id="plus-btn" class="p-2 text-slate-500 hover:text-white transition-colors hover:rotate-90 duration-300 focus:outline-none">
                 <i data-lucide="plus-circle" class="w-6 h-6"></i>
               </button>
            </div>
            
            <input 
              type="text" 
              id="message-input" 
              autocomplete="off"
              placeholder="Message #general-void" 
              class="block w-full pl-12 pr-12 py-3 bg-slate-800/50 border-none rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all font-medium"
            >
            <div class="absolute inset-y-0 right-0 pr-2 flex items-center">
              <button type="submit" class="p-2 hover:bg-white/5 rounded-md text-slate-400 hover:text-white transition-colors">
                <i data-lucide="send" class="w-5 h-5"></i>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Right Column: Online Players -->
      <div class="w-72 bg-slate-900/80 border-l border-white/5 hidden md:flex flex-col backdrop-blur-xl shrink-0">
        <div class="h-16 px-4 border-b border-white/5 flex items-center gap-2 text-slate-400 font-semibold uppercase text-xs tracking-wider shrink-0">
          <i data-lucide="users" class="w-4 h-4"></i>
          <span>Online Spirits</span>
        </div>
        <div id="users-list" class="flex-1 overflow-y-auto p-3 space-y-1">
          <!-- User Item Template (Dynamic) -->
        </div>
      </div>

    </div>

    <!-- TEXT STUDIO MODAL -->
    <div id="text-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-300">
        <div class="relative w-full max-w-4xl p-4 animate-pop h-[90vh]">
           <div class="glass-panel rounded-3xl p-6 border border-white/10 shadow-2xl flex flex-col md:flex-row gap-6 bg-[#0f172a] h-full overflow-hidden">
               <button id="close-text-btn" class="absolute top-6 right-6 z-20 text-slate-400 hover:text-white transition-colors p-2 bg-black/50 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
               <div class="w-full md:w-1/3 bg-black/40 rounded-2xl p-6 flex flex-col justify-center items-center border border-white/5 shrink-0 relative overflow-hidden">
                   <div class="text-xs font-mono uppercase text-slate-500 absolute top-4 left-4">Live Preview</div>
                   <div class="space-y-6 text-center">
                       <div class="p-4 rounded-xl bg-white/5"><div class="text-xs text-slate-500 mb-2">Username Style</div><span id="ts-preview-username" class="text-2xl font-bold">Your Name</span></div>
                       <div class="p-4 rounded-xl bg-white/5"><div class="text-xs text-slate-500 mb-2">Message Style</div><p id="ts-preview-text" class="text-lg">This is how your soul speaks.</p></div>
                   </div>
                   <button id="ts-save-btn" class="mt-8 px-8 py-3 rounded-xl bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold shadow-lg shadow-pink-500/20 transition-all active:scale-95">Apply Styles</button>
               </div>
               <div class="flex-1 flex flex-col min-h-0">
                   <div class="flex p-1 bg-slate-800/80 rounded-xl mb-4 shrink-0"><button class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all bg-indigo-600 text-white shadow-lg" id="ts-tab-username">Username</button><button class="flex-1 py-2 rounded-lg text-sm font-semibold text-slate-400 hover:text-white transition-all" id="ts-tab-text">Text Message</button></div>
                   <div class="flex gap-2 mb-4 shrink-0 overflow-x-auto pb-2"><button class="px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider bg-white/10 border border-white/10 text-white hover:bg-white/20 transition-all ts-type-btn active" data-type="solid">Colours</button><button class="px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider border border-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all ts-type-btn" data-type="gradient">Gradients</button><button class="px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider border border-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all ts-type-btn" data-type="neon">Neon</button></div>
                   <div class="flex-1 overflow-y-auto pr-2 space-y-6"><div><div class="flex items-center justify-between mb-2"><label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Font (50+)</label><span id="ts-current-font" class="text-xs text-indigo-400">Default</span></div><div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="ts-font-grid"></div></div><div><label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block" id="ts-color-label">Palette (50)</label><div class="grid grid-cols-5 md:grid-cols-8 gap-3" id="ts-color-grid"></div></div></div>
               </div>
           </div>
        </div>
    </div>

    <!-- FX STUDIO MODAL (Card Effects) -->
    <div id="fx-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-300">
        <div class="relative w-full max-w-4xl p-4 animate-pop h-[90vh]">
           <div class="glass-panel rounded-3xl p-6 border border-white/10 shadow-2xl flex flex-col md:flex-row gap-6 bg-[#0f172a] h-full overflow-hidden">
               <button id="close-fx-btn" class="absolute top-6 right-6 z-20 text-slate-400 hover:text-white transition-colors p-2 bg-black/50 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
               
               <!-- Preview -->
               <div class="w-full md:w-1/3 bg-black/40 rounded-2xl p-6 flex flex-col justify-center items-center border border-white/5 shrink-0 relative overflow-hidden">
                   <div class="text-xs font-mono uppercase text-slate-500 absolute top-4 left-4">Live Preview</div>
                   <div class="space-y-8 w-full">
                       <!-- Mock Profile Card -->
                       <div>
                           <div class="text-xs text-slate-500 mb-2 text-center">Profile Background</div>
                           <div id="fx-preview-profile" class="w-full h-40 rounded-xl border border-white/10 relative overflow-hidden flex items-center justify-center shadow-2xl">
                               <span class="relative z-10 font-bold text-white text-shadow">Profile Card</span>
                           </div>
                       </div>
                       <!-- Mock User Card -->
                       <div>
                           <div class="text-xs text-slate-500 mb-2 text-center">Online User Card</div>
                           <div id="fx-preview-card" class="w-full p-3 rounded-lg border border-white/10 flex items-center gap-3">
                               <div class="w-8 h-8 rounded-full bg-slate-700"></div>
                               <div class="flex-1 h-3 bg-slate-700 rounded w-1/2"></div>
                           </div>
                       </div>
                   </div>
                   <button id="fx-save-btn" class="mt-8 px-8 py-3 rounded-xl bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white font-bold shadow-lg shadow-violet-500/20 transition-all active:scale-95">Apply FX</button>
               </div>

               <!-- Controls -->
               <div class="flex-1 flex flex-col min-h-0">
                   <div class="flex p-1 bg-slate-800/80 rounded-xl mb-4 shrink-0">
                       <button class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all bg-violet-600 text-white shadow-lg" id="fx-tab-profile">Profile Background</button>
                       <button class="flex-1 py-2 rounded-lg text-sm font-semibold text-slate-400 hover:text-white transition-all" id="fx-tab-card">User Card</button>
                   </div>
                   <div class="flex-1 overflow-y-auto pr-2">
                       <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Choose Effect (50+)</label>
                       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" id="fx-grid"></div>
                   </div>
               </div>
           </div>
        </div>
    </div>

    <!-- WALLET MODAL -->
    <div id="wallet-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-300">
        <div class="relative w-full max-w-lg p-6 animate-pop">
           <div class="glass-panel rounded-3xl p-8 border-2 border-white/10 shadow-[0_0_50px_rgba(79,70,229,0.3)]">
              <button id="close-wallet-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors p-2">
                 <i data-lucide="x" class="w-6 h-6"></i>
              </button>
              
              <div class="text-center mb-8">
                 <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-300 to-cyan-300 mb-2">Spirit Wallet</h2>
                 <p class="text-slate-400 text-sm">Your ethereal possessions</p>
              </div>

              <div class="grid grid-cols-2 gap-6">
                 <!-- Coins Card -->
                 <div class="bg-slate-900/50 rounded-2xl p-6 flex flex-col items-center border border-yellow-500/20 shadow-lg shadow-yellow-500/10 animate-jump-in" style="animation-delay: 0.1s;">
                    <div class="w-16 h-16 rounded-full bg-yellow-500/20 flex items-center justify-center mb-4 border border-yellow-500/50 animate-bounce">
                       <i data-lucide="coins" class="w-8 h-8 text-yellow-400"></i>
                    </div>
                    <span class="text-slate-400 text-xs uppercase tracking-wider font-semibold mb-1">Soul Coins</span>
                    <span id="wallet-coins" class="text-2xl font-bold text-yellow-100">0</span>
                 </div>

                 <!-- Gems Card -->
                 <div class="bg-slate-900/50 rounded-2xl p-6 flex flex-col items-center border border-pink-500/20 shadow-lg shadow-pink-500/10 animate-jump-in" style="animation-delay: 0.3s;">
                    <div class="w-16 h-16 rounded-full bg-pink-500/20 flex items-center justify-center mb-4 border border-pink-500/50 animate-bounce" style="animation-delay: 0.2s;">
                       <i data-lucide="gem" class="w-8 h-8 text-pink-400"></i>
                    </div>
                    <span class="text-slate-400 text-xs uppercase tracking-wider font-semibold mb-1">Void Gems</span>
                    <span id="wallet-gems" class="text-2xl font-bold text-pink-100">0</span>
                 </div>
              </div>
           </div>
        </div>
    </div>

    <!-- PAINT STUDIO MODAL -->
    <div id="paint-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-300">
      <div class="relative w-full max-w-2xl p-4 animate-jump-in">
        <div class="glass-panel rounded-3xl p-6 border border-white/10 shadow-2xl flex flex-col items-center gap-4 bg-[#0f172a]">
           <!-- Header -->
           <div class="w-full flex items-center justify-between border-b border-white/10 pb-4">
              <div class="flex items-center gap-2">
                 <i data-lucide="palette" class="w-5 h-5 text-indigo-400"></i>
                 <span class="font-bold text-slate-200">Paint Studio</span>
              </div>
              <button id="close-paint-btn" class="text-slate-400 hover:text-white transition-colors p-1">
                 <i data-lucide="x" class="w-6 h-6"></i>
              </button>
           </div>
           
           <!-- Canvas Area -->
           <div class="relative rounded-lg overflow-hidden border border-white/10 shadow-inner bg-[url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMUlEQVQ4T2NkYGAQYcAP3uCTZhw1gGGYhAGBZIA/nYDCgBDAm9BGDWAAjyQc6WCgAgA0OezR/X669AAAAABJRU5ErkJggg==')]">
              <canvas id="paint-canvas" width="500" height="500" class="block bg-transparent"></canvas>
           </div>

           <!-- Toolbar -->
           <div class="w-full flex flex-wrap items-center justify-between gap-4 pt-2">
              <div class="flex items-center gap-3">
                 <!-- Color -->
                 <div class="relative group">
                    <input type="color" id="paint-color" value="#00ffff" class="w-10 h-10 rounded-full cursor-pointer bg-transparent overflow-hidden">
                    <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-[10px] bg-black/80 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Color</div>
                 </div>
                 
                 <!-- Size -->
                 <div class="flex items-center gap-2 group relative">
                    <i data-lucide="circle" class="w-3 h-3 text-slate-400"></i>
                    <input type="range" id="paint-size" min="1" max="50" value="5" class="w-24 accent-indigo-500 cursor-pointer">
                    <i data-lucide="circle" class="w-6 h-6 text-slate-400"></i>
                    <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-[10px] bg-black/80 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Size</div>
                 </div>
              </div>

              <div class="flex items-center gap-2">
                  <!-- Eraser -->
                  <button id="paint-eraser" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors border border-white/5 relative group">
                      <i data-lucide="eraser" class="w-5 h-5"></i>
                      <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-[10px] bg-black/80 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Eraser</div>
                  </button>
                  
                  <!-- Clear -->
                  <button id="paint-clear" class="p-2 rounded-lg bg-slate-800 hover:bg-red-900/30 text-slate-300 hover:text-red-300 transition-colors border border-white/5 relative group">
                      <i data-lucide="trash-2" class="w-5 h-5"></i>
                      <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-[10px] bg-black/80 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Clear</div>
                  </button>
              </div>

              <!-- Save -->
              <button id="paint-save" class="px-6 py-2 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-semibold shadow-lg shadow-indigo-500/20 transition-all active:scale-95 flex items-center gap-2">
                 <span>Send Art</span>
                 <i data-lucide="send" class="w-4 h-4"></i>
              </button>
           </div>
        </div>
      </div>
    </div>

    <!-- PROFILE MODAL (Used for both Edit and View) -->
    <div id="profile-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-300">
        <div class="relative w-full max-w-md animate-pop">
           <div class="glass-panel rounded-3xl overflow-hidden shadow-2xl border border-white/10 bg-[#0f172a]">
              
              <!-- Banner Section -->
              <div class="relative h-40 bg-slate-800 group">
                 <img id="profile-banner-img" src="" class="w-full h-full object-cover hidden">
                 <div id="profile-banner-placeholder" class="w-full h-full bg-gradient-to-r from-indigo-900 to-purple-900 flex items-center justify-center">
                    <i data-lucide="image" class="w-8 h-8 text-white/20"></i>
                 </div>
                 
                 <!-- Edit Overlay (Only if editable and NOT in preview mode) -->
                 <div id="banner-edit-overlay" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer hidden">
                    <span class="text-white text-xs font-semibold uppercase tracking-wider flex items-center gap-2">
                       <i data-lucide="upload" class="w-4 h-4"></i> Change Banner
                    </span>
                 </div>
                 
                 <!-- Toggle Preview Button (Only visible if it is your profile) -->
                 <button id="toggle-view-btn" class="absolute top-4 left-4 bg-black/30 hover:bg-black/50 text-white rounded-full p-2 transition-colors z-20 hidden" title="Toggle Preview">
                     <i id="toggle-view-icon" data-lucide="eye" class="w-5 h-5"></i>
                 </button>

                 <button id="close-profile-btn" class="absolute top-4 right-4 bg-black/30 hover:bg-black/50 text-white rounded-full p-2 transition-colors z-20">
                    <i data-lucide="x" class="w-5 h-5"></i>
                 </button>
              </div>

              <!-- Profile Content -->
              <div class="px-8 pb-8">
                 <div class="flex justify-between items-end -mt-12 mb-6">
                    <!-- Avatar -->
                    <div class="relative w-24 h-24 rounded-full border-4 border-[#0f172a] bg-slate-800 overflow-hidden group shadow-lg">
                       <img id="profile-pfp-img" src="" class="w-full h-full object-cover hidden">
                       <div id="profile-pfp-placeholder" class="w-full h-full flex items-center justify-center bg-slate-700 text-indigo-400">
                          <i data-lucide="ghost" class="w-10 h-10"></i>
                       </div>
                       <!-- Edit Overlay (Only if editable and NOT in preview mode) -->
                       <div id="pfp-edit-overlay" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer hidden">
                           <i data-lucide="camera" class="w-6 h-6 text-white"></i>
                       </div>
                    </div>
                    
                    <!-- Like Button (View Mode) -->
                    <button id="like-btn" class="mb-2 px-4 py-2 rounded-full bg-slate-800 border border-slate-700 hover:bg-slate-700 transition-all flex items-center gap-2 group active:scale-95">
                        <i id="like-icon" data-lucide="heart" class="w-5 h-5 text-slate-400 group-hover:text-pink-500 transition-colors"></i>
                        <span id="like-count" class="text-slate-300 text-sm font-semibold">0</span>
                    </button>
                 </div>

                 <form id="profile-form" class="space-y-4">
                    <!-- Username -->
                    <div>
                       <label class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">Soul Name</label>
                       <input type="text" id="profile-username" class="w-full bg-transparent border-b border-slate-700 py-2 text-xl font-bold text-white focus:outline-none focus:border-indigo-500 transition-colors placeholder-slate-600 disabled:border-transparent disabled:cursor-default" disabled>
                    </div>

                     <!-- Mood Input -->
                    <div>
                       <label class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">Current Vibe (Mood)</label>
                       <input type="text" id="profile-mood" maxlength="30" class="w-full bg-transparent border-b border-slate-700 py-2 text-slate-300 focus:outline-none focus:border-indigo-500 transition-colors placeholder-slate-600 disabled:border-transparent disabled:cursor-default" disabled placeholder="Haunting...">
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                       <!-- Age -->
                       <div>
                          <label class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">Eons (Age)</label>
                          <input type="number" id="profile-age" class="w-full bg-transparent border-b border-slate-700 py-2 text-slate-300 focus:outline-none focus:border-indigo-500 transition-colors placeholder-slate-600 disabled:border-transparent disabled:cursor-default" disabled>
                       </div>
                       <!-- Gender -->
                       <div>
                          <label class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">Essence</label>
                          <select id="profile-gender" class="w-full bg-transparent border-b border-slate-700 py-2 text-slate-300 focus:outline-none focus:border-indigo-500 transition-colors disabled:border-transparent disabled:appearance-none disabled:cursor-default" disabled>
                             <option value="Unknown">Unknown</option>
                             <option value="Male">Male</option>
                             <option value="Female">Female</option>
                             <option value="Non-binary">Non-binary</option>
                             <option value="Spirit">Spirit</option>
                          </select>
                       </div>
                    </div>
                    
                    <!-- Bio Input -->
                    <div>
                       <label class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">Ethereal Bio</label>
                       <textarea id="profile-bio" rows="3" maxlength="150" class="w-full bg-transparent border border-slate-700 rounded-lg p-2 text-slate-300 focus:outline-none focus:border-indigo-500 transition-colors placeholder-slate-600 disabled:border-transparent disabled:resize-none disabled:p-0" disabled placeholder="Whisper your story..."></textarea>
                    </div>

                    <!-- Save Button (Edit Mode) -->
                    <button type="submit" id="profile-save-btn" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 rounded-xl shadow-lg shadow-indigo-500/20 transition-all active:scale-95 hidden">
                       Save Changes
                    </button>
                 </form>
              </div>
           </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, collection, addDoc, setDoc, getDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyBdJsgC-Y_GUWuDzo3Z_KG_z25-oq1C8Sg",
        authDomain: "ghostchat-31f7c.firebaseapp.com",
        projectId: "ghostchat-31f7c",
        storageBucket: "ghostchat-31f7c.firebasestorage.app",
        messagingSenderId: "480466984505",
        appId: "1:480466984505:web:f9ed7896449d40a15077e8",
        measurementId: "G-NBQ3563H1D"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOM Elements
      const authContainer = document.getElementById('auth-container');
      const chatContainer = document.getElementById('chat-container');
      const authForm = document.getElementById('auth-form');
      
      const profileBtn = document.getElementById('profile-btn');
      const profileInitial = document.getElementById('profile-initial');
      const headerAvatarImg = document.getElementById('header-avatar-img');
      const profileDropdown = document.getElementById('profile-dropdown');
      const walletBtn = document.getElementById('wallet-btn');
      const myProfileBtn = document.getElementById('my-profile-btn');
      const logoutBtn = document.getElementById('logout-btn');

      const walletModal = document.getElementById('wallet-modal');
      const closeWalletBtn = document.getElementById('close-wallet-btn');
      const walletCoins = document.getElementById('wallet-coins');
      const walletGems = document.getElementById('wallet-gems');

      // Profile Modal Elements
      const profileModal = document.getElementById('profile-modal');
      const closeProfileBtn = document.getElementById('close-profile-btn');
      const profileForm = document.getElementById('profile-form');
      const profileUsername = document.getElementById('profile-username');
      const profileAge = document.getElementById('profile-age');
      const profileGender = document.getElementById('profile-gender');
      const profileMood = document.getElementById('profile-mood');
      const profileBio = document.getElementById('profile-bio');
      const profileSaveBtn = document.getElementById('profile-save-btn');
      
      const profileBannerImg = document.getElementById('profile-banner-img');
      const profileBannerPlaceholder = document.getElementById('profile-banner-placeholder');
      const bannerEditOverlay = document.getElementById('banner-edit-overlay');
      const profilePfpImg = document.getElementById('profile-pfp-img');
      const profilePfpPlaceholder = document.getElementById('profile-pfp-placeholder');
      const pfpEditOverlay = document.getElementById('pfp-edit-overlay');
      
      const likeBtn = document.getElementById('like-btn');
      const likeCount = document.getElementById('like-count');
      const toggleViewBtn = document.getElementById('toggle-view-btn');

      // Paint Modal Elements
      const paintModal = document.getElementById('paint-modal');
      const closePaintBtn = document.getElementById('close-paint-btn');
      const paintCanvas = document.getElementById('paint-canvas');
      const paintColor = document.getElementById('paint-color');
      const paintSize = document.getElementById('paint-size');
      const paintEraser = document.getElementById('paint-eraser');
      const paintClear = document.getElementById('paint-clear');
      const paintSave = document.getElementById('paint-save');
      const paintBtn = document.getElementById('paint-btn');

      // Text Studio Elements
      const textModal = document.getElementById('text-modal');
      const closeTextBtn = document.getElementById('close-text-btn');
      const textStudioBtn = document.getElementById('text-studio-btn');
      const tsPreviewUsername = document.getElementById('ts-preview-username');
      const tsPreviewText = document.getElementById('ts-preview-text');
      const tsTabUsername = document.getElementById('ts-tab-username');
      const tsTabText = document.getElementById('ts-tab-text');
      const tsFontGrid = document.getElementById('ts-font-grid');
      const tsColorGrid = document.getElementById('ts-color-grid');
      const tsTypeBtns = document.querySelectorAll('.ts-type-btn');
      const tsSaveBtn = document.getElementById('ts-save-btn');
      const tsCurrentFont = document.getElementById('ts-current-font');

      // FX Studio Elements
      const fxModal = document.getElementById('fx-modal');
      const closeFxBtn = document.getElementById('close-fx-btn');
      const fxStudioBtn = document.getElementById('fx-studio-btn');
      const fxTabProfile = document.getElementById('fx-tab-profile');
      const fxTabCard = document.getElementById('fx-tab-card');
      const fxGrid = document.getElementById('fx-grid');
      const fxPreviewProfile = document.getElementById('fx-preview-profile');
      const fxPreviewCard = document.getElementById('fx-preview-card');
      const fxSaveBtn = document.getElementById('fx-save-btn');

      // Hidden inputs
      const fileInputAvatar = document.getElementById('file-input-avatar');
      const fileInputBanner = document.getElementById('file-input-banner');
      const fileInputChat = document.getElementById('file-input-chat');

      // Chat & Input Elements
      const messageForm = document.getElementById('message-form');
      const messageInput = document.getElementById('message-input');
      const messagesList = document.getElementById('messages-list');
      const emptyState = document.getElementById('empty-state');
      const usersList = document.getElementById('users-list');
      const plusBtn = document.getElementById('plus-btn');
      const plusMenu = document.getElementById('plus-menu');
      const chatUploadBtn = document.getElementById('chat-upload-btn');
      
      // Lightbox Elements
      const lightbox = document.getElementById('lightbox');
      const lightboxImg = document.getElementById('lightbox-img');

      const authError = document.getElementById('auth-error');
      const bgElements = document.getElementById('bg-elements');
      
      const usernameContainer = document.getElementById('username-container');
      const usernameInput = document.getElementById('username');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      
      const subtitle = document.getElementById('header-subtitle');
      const submitBtn = document.getElementById('submit-btn');
      const btnText = document.getElementById('btn-text');
      const btnIcon = document.getElementById('btn-icon');
      const btnLoader = document.getElementById('btn-loader');
      const toggleBtn = document.getElementById('toggle-btn');
      const togglePrompt = document.getElementById('toggle-text-prompt');

      let isLogin = true;
      let unsubscribeMessages = null;
      let unsubscribeUsers = null;
      let presenceInterval = null;
      let currentViewedProfileUid = null;
      let isEditingProfile = false;
      let isPreviewMode = false;
      
      // Current User Global State
      let currentUserPfp = null; 
      let currentUserMood = null;
      let currentUserStyle = {
          username: { colorType: 'solid', value: '#ffffff', font: 'Inter' },
          message: { colorType: 'solid', value: '#e2e8f0', font: 'Inter' },
          profileBG: 'none',
          cardBG: 'none'
      };

      // Paint State
      let ctx = null;
      let isDrawing = false;
      let isEraser = false;

      // Text Studio State
      let tsTarget = 'username'; // or 'message'
      let tsActiveType = 'solid'; // solid, gradient, neon
      let tsTempStyle = JSON.parse(JSON.stringify(currentUserStyle)); // deep copy

      // FX Studio State
      let fxTarget = 'profile'; // 'profile' or 'card'
      let fxTempStyle = JSON.parse(JSON.stringify(currentUserStyle));

      // DATA ARRAYS
      const FONTS = [
          "Inter", "Roboto", "Open Sans", "Lato", "Montserrat", "Oswald", "Raleway", "PT Sans", "Merriweather", "Noto Sans", 
          "Nunito", "Prompt", "Work Sans", "Rubik", "Poppins", "Fira Sans", "Mukta", "Quicksand", "Ubuntu", "Playfair Display",
          "Lora", "Anton", "Cabin", "Inconsolata", "Dosis", "Oxygen", "Arimo", "Bitter", "Lobster", "Pacifico",
          "Shadows Into Light", "Indie Flower", "Dancing Script", "Abril Fatface", "Bree Serif", "Fjalla One", "Varela Round", "Comfortaa", "Righteous", "Fredoka One",
          "Kalam", "Permanent Marker", "Orbitron", "Press Start 2P", "Monoton", "Creepster", "Nosifer", "Butcherman", "Eater", "Frijole"
      ];

      const SOLID_COLORS = [
         "#f8fafc", "#f1f5f9", "#e2e8f0", "#cbd5e1", "#94a3b8", "#64748b", "#475569", "#334155", "#1e293b", "#0f172a",
         "#ef4444", "#dc2626", "#b91c1c", "#991b1b", "#7f1d1d", "#f97316", "#ea580c", "#c2410c", "#9a3412", "#7c2d12",
         "#f59e0b", "#d97706", "#b45309", "#92400e", "#78350f", "#eab308", "#ca8a04", "#a16207", "#854d0e", "#713f12",
         "#84cc16", "#65a30d", "#4d7c0f", "#3f6212", "#365314", "#22c55e", "#16a34a", "#15803d", "#166534", "#14532d",
         "#10b981", "#059669", "#047857", "#065f46", "#064e3b", "#14b8a6", "#0d9488", "#0f766e", "#115e59", "#134e4a"
      ];

      const GRADIENTS = Array.from({length: 50}, (_, i) => {
          const h1 = Math.floor(i * (360/50));
          const h2 = (h1 + 60) % 360;
          return `linear-gradient(135deg, hsl(${h1}, 80%, 60%), hsl(${h2}, 80%, 60%))`;
      });

      const NEON_COLORS = [
          "#ff00ff", "#00ffff", "#00ff00", "#ffff00", "#ff0000", "#0000ff", "#ff7f00", "#7f00ff", "#ff007f", "#00ff7f",
          "#ff1493", "#00bfff", "#32cd32", "#ffd700", "#ff4500", "#1e90ff", "#ff69b4", "#8a2be2", "#dc143c", "#00fa9a",
          "#f08080", "#20b2aa", "#98fb98", "#eee8aa", "#ff6347", "#4682b4", "#da70d6", "#9370db", "#cd5c5c", "#66cdaa",
          "#fa8072", "#5f9ea0", "#9acd32", "#bdb76b", "#e9967a", "#b0c4de", "#dda0dd", "#7b68ee", "#f0e68c", "#8fbc8f",
          "#ffb6c1", "#afeeee", "#90ee90", "#fffacd", "#ffa07a", "#87cefa", "#d8bfd8", "#6a5acd", "#ffe4b5", "#3cb371"
      ];

      const PROFILE_BGS = Array.from({length: 60}, (_, i) => {
          if(i===0) return 'none'; // Default
          const hue = Math.floor(i * 6);
          return `linear-gradient(${45 + (i%4)*90}deg, hsl(${hue}, 40%, 15%), hsl(${(hue+60)%360}, 40%, 20%))`;
      });

      const CARD_BGS = Array.from({length: 60}, (_, i) => {
          if(i===0) return 'none'; // Default
          const hue = Math.floor(i * 6);
          // Subtle border effect or full bg
          return `border: 1px solid hsl(${hue}, 70%, 50%); background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent)`;
      });

      // Initialize Icons
      lucide.createIcons();

      // --- HELPERS ---
      
      function formatNumber(num) {
          return new Intl.NumberFormat().format(num);
      }

      function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          obj.innerHTML = formatNumber(Math.floor(progress * (end - start) + start));
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }

      const compressImage = async (file, { quality = 0.7, maxWidth = 800 }) => {
          if (file.size > 1048576) {
              throw new Error("File too large");
          }

          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = (event) => {
                  const img = new Image();
                  img.src = event.target.result;
                  img.onload = () => {
                      const canvas = document.createElement('canvas');
                      let width = img.width;
                      let height = img.height;

                      if (width > maxWidth) {
                          height = Math.round((height * maxWidth) / width);
                          width = maxWidth;
                      }

                      canvas.width = width;
                      canvas.height = height;
                      const ctx = canvas.getContext('2d');
                      ctx.drawImage(img, 0, 0, width, height);
                      resolve(canvas.toDataURL(file.type, quality));
                  };
                  img.onerror = (err) => reject(err);
              };
              reader.onerror = (err) => reject(err);
          });
      };

      // --- FX STUDIO LOGIC ---
      fxStudioBtn.addEventListener('click', () => {
          plusMenu.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
          const icon = plusBtn.firstElementChild;
          if(icon) icon.classList.remove('rotate-45');

          // Reset
          fxTempStyle = JSON.parse(JSON.stringify(currentUserStyle));
          fxTarget = 'profile';
          updateFXUI();
          toggleModal(fxModal, true);
      });

      closeFxBtn.addEventListener('click', () => toggleModal(fxModal, false));

      fxTabProfile.addEventListener('click', () => {
          fxTarget = 'profile';
          updateFXUI();
      });

      fxTabCard.addEventListener('click', () => {
          fxTarget = 'card';
          updateFXUI();
      });

      function updateFXUI() {
          // Tabs
          if (fxTarget === 'profile') {
              fxTabProfile.className = "flex-1 py-2 rounded-lg text-sm font-semibold transition-all bg-violet-600 text-white shadow-lg";
              fxTabCard.className = "flex-1 py-2 rounded-lg text-sm font-semibold text-slate-400 hover:text-white transition-all";
          } else {
              fxTabProfile.className = "flex-1 py-2 rounded-lg text-sm font-semibold text-slate-400 hover:text-white transition-all";
              fxTabCard.className = "flex-1 py-2 rounded-lg text-sm font-semibold transition-all bg-violet-600 text-white shadow-lg";
          }

          // Grid
          fxGrid.innerHTML = '';
          const options = fxTarget === 'profile' ? PROFILE_BGS : CARD_BGS;
          const current = fxTarget === 'profile' ? fxTempStyle.profileBG : fxTempStyle.cardBG;

          options.forEach((opt, idx) => {
              const div = document.createElement('div');
              div.className = `h-20 rounded-lg ts-grid-item relative overflow-hidden ${opt === current ? 'ts-selected' : ''}`;
              
              if(fxTarget === 'profile') {
                  div.style.background = opt === 'none' ? '#0f172a' : opt;
              } else {
                  div.setAttribute('style', opt === 'none' ? '' : opt);
              }
              
              if(opt === 'none') {
                  div.innerHTML = '<span class="absolute inset-0 flex items-center justify-center text-xs text-slate-500">None</span>';
              }

              div.onclick = () => {
                  if(fxTarget === 'profile') fxTempStyle.profileBG = opt;
                  else fxTempStyle.cardBG = opt;
                  updateFXUI();
              };
              fxGrid.appendChild(div);
          });

          // Preview
          if(fxTempStyle.profileBG && fxTempStyle.profileBG !== 'none') {
              fxPreviewProfile.style.background = fxTempStyle.profileBG;
          } else {
              fxPreviewProfile.style.background = ''; // reset to default class
              fxPreviewProfile.className = "w-full h-40 rounded-xl border border-white/10 relative overflow-hidden flex items-center justify-center shadow-2xl bg-[#0f172a]";
          }

          if(fxTempStyle.cardBG && fxTempStyle.cardBG !== 'none') {
              fxPreviewCard.setAttribute('style', fxTempStyle.cardBG);
          } else {
              fxPreviewCard.removeAttribute('style');
          }
      }

      fxSaveBtn.addEventListener('click', async () => {
          const user = auth.currentUser;
          if(!user) return;
          
          try {
             fxSaveBtn.textContent = "Saving...";
             fxSaveBtn.disabled = true;

             currentUserStyle = JSON.parse(JSON.stringify(fxTempStyle));

             // Update Firestore
             await updateDoc(doc(db, "users", user.uid), {
                 style: currentUserStyle
             });

             // Update Online Status
             await updateDoc(doc(db, "online", user.uid), {
                 style: {
                     username: currentUserStyle.username,
                     cardBG: currentUserStyle.cardBG
                 } 
             });

             toggleModal(fxModal, false);

          } catch(e) {
              console.error(e);
              alert("Failed to save FX.");
          } finally {
              fxSaveBtn.textContent = "Apply FX";
              fxSaveBtn.disabled = false;
          }
      });

      // --- TEXT STUDIO LOGIC ---

      textStudioBtn.addEventListener('click', () => {
          plusMenu.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
          const icon = plusBtn.firstElementChild;
          if(icon) icon.classList.remove('rotate-45');
          
          // Reset Temp State to Current
          tsTempStyle = JSON.parse(JSON.stringify(currentUserStyle));
          tsTarget = 'username';
          tsActiveType = tsTempStyle.username.colorType;
          
          updateTSUI();
          toggleModal(textModal, true);
      });

      closeTextBtn.addEventListener('click', () => toggleModal(textModal, false));

      tsTabUsername.addEventListener('click', () => {
          tsTarget = 'username';
          tsActiveType = tsTempStyle.username.colorType;
          updateTSUI();
      });

      tsTabText.addEventListener('click', () => {
          tsTarget = 'message';
          tsActiveType = tsTempStyle.message.colorType;
          updateTSUI();
      });

      tsTypeBtns.forEach(btn => {
          btn.addEventListener('click', (e) => {
              tsActiveType = e.target.getAttribute('data-type');
              tsTempStyle[tsTarget].colorType = tsActiveType;
              
              // Set a default if switching types
              if (tsActiveType === 'solid') tsTempStyle[tsTarget].value = '#ffffff';
              if (tsActiveType === 'gradient') tsTempStyle[tsTarget].value = GRADIENTS[0];
              if (tsActiveType === 'neon') tsTempStyle[tsTarget].value = '#ff00ff';
              
              updateTSUI();
          });
      });

      function updateTSUI() {
          // Update Tabs Look
          if (tsTarget === 'username') {
              tsTabUsername.className = "flex-1 py-2 rounded-lg text-sm font-semibold transition-all bg-indigo-600 text-white shadow-lg";
              tsTabText.className = "flex-1 py-2 rounded-lg text-sm font-semibold text-slate-400 hover:text-white transition-all";
          } else {
              tsTabUsername.className = "flex-1 py-2 rounded-lg text-sm font-semibold text-slate-400 hover:text-white transition-all";
              tsTabText.className = "flex-1 py-2 rounded-lg text-sm font-semibold transition-all bg-indigo-600 text-white shadow-lg";
          }

          // Update Type Buttons Look
          tsTypeBtns.forEach(btn => {
              const type = btn.getAttribute('data-type');
              if (type === tsActiveType) {
                  btn.className = "px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider bg-white/10 border border-white/10 text-white hover:bg-white/20 transition-all ts-type-btn active";
              } else {
                  btn.className = "px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider border border-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all ts-type-btn";
              }
          });

          // Render Fonts
          const currentFont = tsTempStyle[tsTarget].font;
          tsCurrentFont.textContent = currentFont;
          tsFontGrid.innerHTML = '';
          FONTS.forEach(font => {
              const div = document.createElement('div');
              div.className = `ts-font-item text-center truncate ${font === currentFont ? 'ts-font-selected' : 'text-slate-400'}`;
              div.style.fontFamily = font;
              div.textContent = font;
              div.onclick = () => {
                  tsTempStyle[tsTarget].font = font;
                  updateTSUI(); // Re-render to show selection
              };
              tsFontGrid.appendChild(div);
          });

          // Render Colors
          const currentValue = tsTempStyle[tsTarget].value;
          tsColorGrid.innerHTML = '';
          let sourceArray = [];
          if (tsActiveType === 'solid') sourceArray = SOLID_COLORS;
          else if (tsActiveType === 'gradient') sourceArray = GRADIENTS;
          else sourceArray = NEON_COLORS;

          sourceArray.forEach(val => {
              const div = document.createElement('div');
              div.className = `h-10 rounded-lg ts-grid-item ${val === currentValue ? 'ts-selected' : ''}`;
              
              if (tsActiveType === 'solid' || tsActiveType === 'neon') {
                  div.style.backgroundColor = val;
              } else {
                  div.style.background = val;
              }

              div.onclick = () => {
                  tsTempStyle[tsTarget].value = val;
                  updateTSUI();
              };
              tsColorGrid.appendChild(div);
          });

          // Update Preview
          applyStyleToElement(tsPreviewUsername, tsTempStyle.username);
          applyStyleToElement(tsPreviewText, tsTempStyle.message);
      }

      function applyStyleToElement(el, style) {
          el.style.fontFamily = style.font;
          
          // Reset
          el.style.color = '';
          el.style.background = '';
          el.style.webkitBackgroundClip = '';
          el.style.textShadow = '';
          el.style.display = '';

          if (style.colorType === 'solid') {
              el.style.color = style.value;
          } else if (style.colorType === 'gradient') {
              el.style.background = style.value;
              el.style.webkitBackgroundClip = 'text';
              el.style.color = 'transparent';
              el.style.display = 'inline-block'; // Required for clip
          } else if (style.colorType === 'neon') {
              el.style.color = '#fff';
              el.style.textShadow = `0 0 5px ${style.value}, 0 0 10px ${style.value}, 0 0 20px ${style.value}`;
          }
      }

      tsSaveBtn.addEventListener('click', async () => {
          const user = auth.currentUser;
          if(!user) return;
          
          try {
             tsSaveBtn.textContent = "Saving...";
             tsSaveBtn.disabled = true;

             // Update Global State
             currentUserStyle = JSON.parse(JSON.stringify(tsTempStyle));

             // Update Firestore
             await updateDoc(doc(db, "users", user.uid), {
                 style: currentUserStyle
             });

             // Update Online Status
             await updateDoc(doc(db, "online", user.uid), {
                 style: {
                     username: currentUserStyle.username,
                     cardBG: currentUserStyle.cardBG || 'none'
                 }
             });

             toggleModal(textModal, false);

          } catch(e) {
              console.error(e);
              alert("Failed to save styles.");
          } finally {
              tsSaveBtn.textContent = "Apply Styles";
              tsSaveBtn.disabled = false;
          }
      });


      // --- PLUS MENU LOGIC ---
      plusBtn.addEventListener('click', (e) => {
        e.stopPropagation(); 
        plusMenu.classList.toggle('opacity-0');
        plusMenu.classList.toggle('translate-y-4');
        plusMenu.classList.toggle('pointer-events-none');
        const icon = plusBtn.firstElementChild;
        if(icon) icon.classList.toggle('rotate-45'); 
      });

      document.addEventListener('click', (e) => {
        if (!plusMenu.contains(e.target) && !plusBtn.contains(e.target)) {
          if (!plusMenu.classList.contains('opacity-0')) {
             plusMenu.classList.add('opacity-0');
             plusMenu.classList.add('translate-y-4');
             plusMenu.classList.add('pointer-events-none');
             const icon = plusBtn.firstElementChild;
             if(icon) icon.classList.remove('rotate-45');
          }
        }
      });

      // --- CHAT IMAGE UPLOAD ---
      chatUploadBtn.addEventListener('click', () => {
          fileInputChat.click();
          plusMenu.classList.add('opacity-0');
          plusMenu.classList.add('translate-y-4');
          plusMenu.classList.add('pointer-events-none');
          const icon = plusBtn.firstElementChild;
          if(icon) icon.classList.remove('rotate-45');
      });

      fileInputChat.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          const user = auth.currentUser;
          if(!user) return;

          try {
             const base64 = await compressImage(file, { maxWidth: 600, quality: 0.7 });
             
             await addDoc(collection(db, "messages"), {
                text: "", 
                imageURL: base64,
                type: "image",
                uid: user.uid,
                displayName: user.displayName || user.email.split('@')[0],
                photoURL: currentUserPfp || null,
                style: currentUserStyle, // Pass current style snapshot
                createdAt: serverTimestamp()
             });

             fileInputChat.value = ''; 
          } catch(e) {
             console.error(e);
             if(e.message === "File too large") {
                 alert("Image too large (max 1MB).");
             } else {
                 alert("Failed to upload image.");
             }
          }
      });

      // --- PAINT STUDIO LOGIC ---
      paintBtn.addEventListener('click', () => {
          toggleModal(paintModal, true);
          plusMenu.classList.add('opacity-0');
          plusMenu.classList.add('translate-y-4');
          plusMenu.classList.add('pointer-events-none');
          const icon = plusBtn.firstElementChild;
          if(icon) icon.classList.remove('rotate-45');
          
          if(!ctx) initCanvas();
      });

      closePaintBtn.addEventListener('click', () => toggleModal(paintModal, false));

      function initCanvas() {
         if(!paintCanvas) return;
         ctx = paintCanvas.getContext('2d');
         ctx.lineCap = 'round';
         ctx.lineJoin = 'round';
         ctx.lineWidth = 5;
         ctx.strokeStyle = '#00ffff';

         paintCanvas.addEventListener('mousedown', startDrawing);
         paintCanvas.addEventListener('mousemove', draw);
         paintCanvas.addEventListener('mouseup', stopDrawing);
         paintCanvas.addEventListener('mouseout', stopDrawing);

         paintCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("mousedown", {
               clientX: touch.clientX,
               clientY: touch.clientY
            });
            paintCanvas.dispatchEvent(mouseEvent);
         });
         paintCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("mousemove", {
               clientX: touch.clientX,
               clientY: touch.clientY
            });
            paintCanvas.dispatchEvent(mouseEvent);
         });
         paintCanvas.addEventListener('touchend', () => {
             const mouseEvent = new MouseEvent("mouseup", {});
             paintCanvas.dispatchEvent(mouseEvent);
         });
      }

      function startDrawing(e) {
         if(!ctx) return;
         isDrawing = true;
         const rect = paintCanvas.getBoundingClientRect();
         const scaleX = paintCanvas.width / rect.width;
         const scaleY = paintCanvas.height / rect.height;
         
         ctx.beginPath();
         ctx.moveTo((e.clientX - rect.left) * scaleX, (e.clientY - rect.top) * scaleY);
      }

      function draw(e) {
         if(!isDrawing || !ctx) return;
         const rect = paintCanvas.getBoundingClientRect();
         const scaleX = paintCanvas.width / rect.width;
         const scaleY = paintCanvas.height / rect.height;
         
         ctx.lineTo((e.clientX - rect.left) * scaleX, (e.clientY - rect.top) * scaleY);
         ctx.stroke();
      }

      function stopDrawing() {
         if(isDrawing && ctx) {
             ctx.closePath();
             isDrawing = false;
         }
      }

      paintColor.addEventListener('input', (e) => {
          if(!ctx) return;
          isEraser = false;
          paintEraser.classList.remove('bg-indigo-600', 'text-white');
          paintEraser.classList.add('bg-slate-800', 'text-slate-300');
          ctx.strokeStyle = e.target.value;
          ctx.globalCompositeOperation = 'source-over';
      });

      paintSize.addEventListener('input', (e) => {
          if(!ctx) return;
          ctx.lineWidth = e.target.value;
      });

      paintEraser.addEventListener('click', () => {
          if(!ctx) return;
          isEraser = !isEraser;
          if(isEraser) {
              paintEraser.classList.add('bg-indigo-600', 'text-white');
              paintEraser.classList.remove('bg-slate-800', 'text-slate-300');
              ctx.globalCompositeOperation = 'destination-out';
          } else {
              paintEraser.classList.remove('bg-indigo-600', 'text-white');
              paintEraser.classList.add('bg-slate-800', 'text-slate-300');
              ctx.globalCompositeOperation = 'source-over';
              ctx.strokeStyle = paintColor.value;
          }
      });

      paintClear.addEventListener('click', () => {
          if(!ctx) return;
          ctx.clearRect(0, 0, paintCanvas.width, paintCanvas.height);
      });

      paintSave.addEventListener('click', async () => {
          const user = auth.currentUser;
          if(!user || !ctx) return;
          
          try {
             const base64 = paintCanvas.toDataURL('image/png');
             
             await addDoc(collection(db, "messages"), {
                text: "",
                imageURL: base64,
                type: "image",
                uid: user.uid,
                displayName: user.displayName || user.email.split('@')[0],
                photoURL: currentUserPfp || null,
                style: currentUserStyle,
                createdAt: serverTimestamp()
             });

             ctx.clearRect(0, 0, paintCanvas.width, paintCanvas.height);
             toggleModal(paintModal, false);

          } catch(e) {
              console.error(e);
              alert("Failed to send masterpiece.");
          }
      });

      // --- LIGHTBOX LOGIC ---
      window.openLightbox = (url) => {
          lightboxImg.src = url;
          lightbox.classList.remove('hidden');
          void lightbox.offsetWidth;
          lightbox.classList.remove('opacity-0');
          lightbox.classList.add('lightbox-open');
      };

      lightbox.addEventListener('click', () => {
          lightbox.classList.remove('lightbox-open');
          lightbox.classList.add('opacity-0');
          setTimeout(() => {
              lightbox.classList.add('hidden');
              lightboxImg.src = '';
          }, 300);
      });

      // --- GLOBAL OPEN PROFILE ---
      window.openProfile = async (uid) => {
          currentViewedProfileUid = uid;
          const currentUser = auth.currentUser;
          const isMe = currentUser && currentUser.uid === uid;
          isEditingProfile = isMe;
          
          // Reset Preview State
          isPreviewMode = false;
          
          // Reset UI
          profileDropdown.classList.add('hidden');
          profileUsername.value = "Summoning...";
          profileAge.value = "";
          profileGender.value = "Unknown";
          profileMood.value = "";
          profileBio.value = "";
          profileBannerImg.classList.add('hidden');
          profileBannerPlaceholder.classList.remove('hidden');
          profilePfpImg.classList.add('hidden');
          profilePfpPlaceholder.classList.remove('hidden');
          toggleViewBtn.classList.add('hidden');
          
          // Reset Profile Modal Background
          const glassPanel = profileModal.querySelector('.glass-panel');
          glassPanel.style.background = ''; // clear inline style

          toggleModal(profileModal, true);

          try {
              const docRef = doc(db, "users", uid);
              const docSnap = await getDoc(docRef);
              const data = docSnap.exists() ? docSnap.data() : {};
              
              // Fill Data
              profileUsername.value = data.displayName || "Unknown Spirit";
              profileAge.value = data.age || "";
              profileGender.value = data.gender || "Unknown";
              profileMood.value = data.mood || "";
              profileBio.value = data.bio || "";
              
              // Apply Profile FX
              if(data.style && data.style.profileBG && data.style.profileBG !== 'none') {
                  glassPanel.style.background = data.style.profileBG;
              } else {
                  glassPanel.style.background = '';
              }

              // Images
              if (data.bannerURL) {
                  profileBannerImg.src = data.bannerURL;
                  profileBannerImg.classList.remove('hidden');
                  profileBannerPlaceholder.classList.add('hidden');
              }
              
              // Use Firestore PFP first, falling back to local cached if me
              const pfp = data.photoURL || (isMe ? currentUserPfp : null);
              if (pfp) {
                  profilePfpImg.src = pfp;
                  profilePfpImg.classList.remove('hidden');
                  profilePfpPlaceholder.classList.add('hidden');
              }

              // Setup Likes
              const likes = data.likes || 0;
              likeCount.textContent = formatNumber(likes);
              
              // Like Status Check
              const likedBy = data.likedBy || [];
              const isLiked = likedBy.includes(currentUser.uid);
              
              const icon = likeBtn.querySelector('svg') || likeBtn.querySelector('i');

              if (isLiked) {
                  if(icon) icon.classList.add('fill-pink-500', 'text-pink-500');
                  likeBtn.classList.add('border-pink-500/30', 'bg-pink-500/10');
              } else {
                  if(icon) icon.classList.remove('fill-pink-500', 'text-pink-500');
                  likeBtn.classList.remove('border-pink-500/30', 'bg-pink-500/10');
              }

              // UI State: Edit vs View
              if (isMe) {
                  setProfileMode('edit');
                  toggleViewBtn.classList.remove('hidden');
                  
                  bannerEditOverlay.onclick = () => fileInputBanner.click();
                  pfpEditOverlay.onclick = () => fileInputAvatar.click();

                  // Show like count but disable interaction for self
                  likeBtn.classList.remove('hidden');
                  likeBtn.disabled = true;
                  likeBtn.classList.add('opacity-70', 'cursor-default');
                  
              } else {
                  setProfileMode('view');
                  toggleViewBtn.classList.add('hidden');
                  
                  likeBtn.classList.remove('hidden');
                  likeBtn.disabled = false;
                  likeBtn.classList.remove('opacity-70', 'cursor-default');
              }

          } catch (e) {
              console.error(e);
              profileUsername.value = "Error summoning spirit";
          }
      };

      function setProfileMode(mode) {
          if (mode === 'edit') {
              // Edit Mode
              profileUsername.disabled = false;
              profileAge.disabled = false;
              profileGender.disabled = false;
              profileMood.disabled = false;
              profileBio.disabled = false;
              profileSaveBtn.classList.remove('hidden');
              bannerEditOverlay.classList.remove('hidden');
              pfpEditOverlay.classList.remove('hidden');
              
              toggleViewBtn.innerHTML = '<i data-lucide="eye" class="w-5 h-5"></i>';
              
          } else {
              // View Mode
              profileUsername.disabled = true;
              profileAge.disabled = true;
              profileGender.disabled = true;
              profileMood.disabled = true;
              profileBio.disabled = true;
              profileSaveBtn.classList.add('hidden');
              bannerEditOverlay.classList.add('hidden');
              pfpEditOverlay.classList.add('hidden');

              toggleViewBtn.innerHTML = '<i data-lucide="pencil" class="w-5 h-5"></i>';
          }
          lucide.createIcons();
      }

      function toggleModal(modal, show) {
          if (show) {
              modal.classList.remove('hidden');
              void modal.offsetWidth; 
              modal.classList.remove('opacity-0');
          } else {
              modal.classList.add('opacity-0');
              setTimeout(() => {
                  modal.classList.add('hidden');
              }, 300);
          }
      }

      closeProfileBtn.addEventListener('click', () => toggleModal(profileModal, false));
      closeWalletBtn.addEventListener('click', () => toggleModal(walletModal, false));

      toggleViewBtn.addEventListener('click', () => {
          if (!isEditingProfile) return;
          isPreviewMode = !isPreviewMode;
          setProfileMode(isPreviewMode ? 'view' : 'edit');
      });

      // --- PROFILE ACTIONS ---

      // Save Profile
      profileForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!isEditingProfile) return;
          
          const user = auth.currentUser;
          const newName = profileUsername.value;
          const newAge = profileAge.value;
          const newGender = profileGender.value;
          const newMood = profileMood.value;
          const newBio = profileBio.value;
          
          const newPfp = (!profilePfpImg.classList.contains('hidden')) ? profilePfpImg.src : null;
          const newBanner = (!profileBannerImg.classList.contains('hidden')) ? profileBannerImg.src : null;

          try {
             profileSaveBtn.textContent = "Saving...";
             profileSaveBtn.disabled = true;

             await updateProfile(user, { displayName: newName });
             
             await setDoc(doc(db, "users", user.uid), {
                 displayName: newName,
                 photoURL: newPfp || null,
                 bannerURL: newBanner || null,
                 age: newAge,
                 gender: newGender,
                 mood: newMood,
                 bio: newBio,
                 style: currentUserStyle
             }, { merge: true });

             currentUserPfp = newPfp || null;
             currentUserMood = newMood || null;
             updateHeaderAvatar(user.displayName, currentUserPfp);
             
             await updateDoc(doc(db, "online", user.uid), {
                 displayName: newName,
                 photoURL: newPfp || null,
                 mood: newMood || null,
                 style: {
                     username: currentUserStyle.username,
                     cardBG: currentUserStyle.cardBG || 'none'
                 }
             });

             toggleModal(profileModal, false);

          } catch(e) {
              console.error(e);
              alert("Failed to save profile. Ensure images are not too massive.");
          } finally {
              profileSaveBtn.textContent = "Save Changes";
              profileSaveBtn.disabled = false;
          }
      });

      // Like Profile
      likeBtn.addEventListener('click', async () => {
          if(!currentViewedProfileUid) return;
          const user = auth.currentUser;
          if (user.uid === currentViewedProfileUid) return;

          const userRef = doc(db, "users", currentViewedProfileUid);
          const icon = likeBtn.querySelector('svg') || likeBtn.querySelector('i');
          const isLiked = icon && icon.classList.contains('fill-pink-500');
          let currentCount = parseInt(likeCount.textContent.replace(/,/g, ''));
          
          if (isLiked) {
             if(icon) icon.classList.remove('fill-pink-500', 'text-pink-500');
             likeBtn.classList.remove('border-pink-500/30', 'bg-pink-500/10');
             likeCount.textContent = formatNumber(currentCount - 1);
             
             await updateDoc(userRef, {
                 likes: increment(-1),
                 likedBy: arrayRemove(user.uid)
             });
          } else {
             if(icon) {
                 icon.classList.add('fill-pink-500', 'text-pink-500');
                 icon.style.animation = 'none';
                 void icon.offsetWidth;
                 icon.style.animation = 'heartBeat 0.3s ease-in-out';
             }
             likeBtn.classList.add('border-pink-500/30', 'bg-pink-500/10');
             likeCount.textContent = formatNumber(currentCount + 1);

             await updateDoc(userRef, {
                 likes: increment(1),
                 likedBy: arrayUnion(user.uid)
             });
          }
      });

      fileInputAvatar.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          try {
              const base64 = await compressImage(file, { maxWidth: 200, quality: 0.8 });
              profilePfpImg.src = base64;
              profilePfpImg.classList.remove('hidden');
              profilePfpPlaceholder.classList.add('hidden');
          } catch(e) {
              alert("Image processing failed or file too large.");
          }
      });

      fileInputBanner.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          try {
              const base64 = await compressImage(file, { maxWidth: 600, quality: 0.7 });
              profileBannerImg.src = base64;
              profileBannerImg.classList.remove('hidden');
              profileBannerPlaceholder.classList.add('hidden');
          } catch(e) {
               alert("Image processing failed or file too large.");
          }
      });

      // --- AUTH UI LOGIC ---

      toggleBtn.addEventListener('click', () => {
        isLogin = !isLogin;
        authError.classList.add('hidden');
        if (isLogin) {
          usernameContainer.classList.add('hidden-group');
          usernameContainer.classList.remove('visible-group');
          usernameInput.removeAttribute('required');
          subtitle.textContent = 'Welcome back to the void.';
          btnText.textContent = 'Resurrect';
          togglePrompt.textContent = "Don't have a vessel?";
          toggleBtn.textContent = 'Create Account';
        } else {
          usernameContainer.classList.remove('hidden-group');
          usernameContainer.classList.add('visible-group');
          usernameInput.setAttribute('required', 'true');
          subtitle.textContent = 'Begin your ethereal journey.';
          btnText.textContent = 'Materialize';
          togglePrompt.textContent = "Already haunting us?";
          toggleBtn.textContent = 'Login';
        }
      });

      profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          profileDropdown.classList.toggle('hidden');
          if(!profileDropdown.classList.contains('hidden')) {
              profileDropdown.classList.add('dropdown-enter-active');
              profileDropdown.classList.remove('dropdown-exit-active');
          }
      });
      document.addEventListener('click', (e) => {
          if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
              if(!profileDropdown.classList.contains('hidden')) {
                  profileDropdown.classList.add('hidden');
              }
          }
      });
      
      walletBtn.addEventListener('click', async () => {
          const user = auth.currentUser;
          if(!user) return;
          try {
             const userDoc = await getDoc(doc(db, "users", user.uid));
             const userData = userDoc.exists() ? userDoc.data() : { coins: 0, gems: 0 };
             toggleModal(walletModal, true);
             animateValue(walletCoins, 0, userData.coins || 0, 1500);
             animateValue(walletGems, 0, userData.gems || 0, 1500);
          } catch(e) { console.error(e); }
      });

      myProfileBtn.addEventListener('click', () => {
          const user = auth.currentUser;
          if(user) openProfile(user.uid);
      });

      // --- AUTH STATE & INIT ---

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          authContainer.classList.add('hidden');
          bgElements.classList.add('opacity-0'); 
          chatContainer.classList.remove('hidden');
          chatContainer.classList.add('flex');
          
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);
          
          let pfp = null;
          let mood = null;
          let name = user.displayName || user.email.split('@')[0];

          if (userSnap.exists()) {
              const data = userSnap.data();
              pfp = data.photoURL || null; 
              mood = data.mood || null;
              name = data.displayName || name;
              
              if(data.style) {
                  currentUserStyle = data.style;
              }
          } else {
              await setDoc(userRef, {
                  coins: 10000,
                  gems: 10000,
                  likes: 0,
                  likedBy: [],
                  displayName: name,
                  photoURL: null,
                  mood: null,
                  bio: "",
                  style: currentUserStyle,
                  createdAt: serverTimestamp()
              }, { merge: true });
          }
          
          currentUserPfp = pfp;
          currentUserMood = mood;
          updateHeaderAvatar(name, currentUserPfp);

          startChatListener();
          setupPresence(user);
        } else {
          authContainer.classList.remove('hidden');
          bgElements.classList.remove('opacity-0');
          chatContainer.classList.add('hidden');
          chatContainer.classList.remove('flex');
          profileDropdown.classList.add('hidden');
          
          currentUserPfp = null;
          currentUserMood = null;

          if (unsubscribeMessages) unsubscribeMessages();
          if (unsubscribeUsers) unsubscribeUsers();
          if (presenceInterval) clearInterval(presenceInterval);
          
          messagesList.innerHTML = '';
          messagesList.appendChild(emptyState);
          emptyState.style.display = 'flex';
          usersList.innerHTML = '';
        }
      });

      function updateHeaderAvatar(name, photoUrl) {
          if (photoUrl) {
              headerAvatarImg.src = photoUrl;
              headerAvatarImg.classList.remove('hidden');
              profileInitial.classList.add('hidden');
          } else {
              headerAvatarImg.classList.add('hidden');
              profileInitial.classList.remove('hidden');
              profileInitial.textContent = name ? name.charAt(0).toUpperCase() : '?';
          }
      }

      // --- CHAT & PRESENCE ---

      async function setupPresence(user) {
        const userRef = doc(db, "online", user.uid);
        const updateStatus = async () => {
            const currentName = auth.currentUser.displayName || (auth.currentUser.email ? auth.currentUser.email.split('@')[0] : 'Ghost');
            
            await setDoc(userRef, {
                uid: user.uid,
                displayName: currentName,
                photoURL: currentUserPfp || null,
                mood: currentUserMood || null,
                style: {
                    username: currentUserStyle.username,
                    cardBG: currentUserStyle.cardBG || 'none'
                },
                lastSeen: serverTimestamp()
            }, { merge: true });
        };
        await updateStatus();
        presenceInterval = setInterval(updateStatus, 60000);

        const q = query(collection(db, "online"), orderBy("lastSeen", "desc"));
        unsubscribeUsers = onSnapshot(q, (snapshot) => {
            const validUids = new Set();
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                if (!data.uid) return;

                const lastSeen = data.lastSeen ? data.lastSeen.toDate() : new Date();
                const diff = (new Date() - lastSeen) / 1000 / 60; 
                
                if (diff < 5) {
                    validUids.add(data.uid);
                    updateUserListElement(data);
                }
            });

            Array.from(usersList.children).forEach(child => {
               const uid = child.getAttribute('data-uid');
               if(uid && !validUids.has(uid)) {
                   child.remove();
               }
            });
        });

        window.addEventListener("beforeunload", () => { deleteDoc(userRef); });
      }

      function updateUserListElement(data) {
          const existing = document.querySelector(`#users-list > div[data-uid="${data.uid}"]`);
          
          const newPfp = data.photoURL || '';
          const newName = data.displayName || 'Ghost';
          const newMood = data.mood || '';
          const newStyleStr = JSON.stringify(data.style || {}); 

          const generateInner = (pfp, name, mood, styleObj) => {
              let avatarHTML;
              if (pfp && pfp !== 'null') {
                  avatarHTML = `<img src="${pfp}" class="w-8 h-8 rounded-full object-cover border border-white/10 group-hover:border-indigo-500/50">`;
              } else {
                  avatarHTML = `
                   <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center border border-white/10 group-hover:border-indigo-500/50 transition-colors">
                     <i data-lucide="ghost" class="w-4 h-4 text-slate-400 group-hover:text-indigo-400"></i>
                   </div>`;
              }
              
              const moodHTML = mood ? `<div class="text-[10px] font-bold italic text-indigo-300 truncate pointer-events-none mt-0.5">${mood}</div>` : '';

              // Apply User Style (Username)
              let nameStyle = `font-family: ${styleObj.username?.font || 'Inter'};`;
              const uObj = styleObj.username || {};
              if (uObj.colorType === 'solid') {
                  nameStyle += `color: ${uObj.value};`;
              } else if (uObj.colorType === 'gradient') {
                  nameStyle += `background: ${uObj.value}; -webkit-background-clip: text; color: transparent; display: inline-block;`;
              } else if (uObj.colorType === 'neon') {
                  nameStyle += `color: #fff; text-shadow: 0 0 5px ${uObj.value}, 0 0 10px ${uObj.value};`;
              } else {
                  nameStyle += `color: #cbd5e1;`; // Default slate-300
              }

              return `
                 <div class="relative pointer-events-none shrink-0">
                   ${avatarHTML}
                   <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-slate-900 rounded-full"></div>
                 </div>
                 <div class="flex flex-col min-w-0 overflow-hidden">
                    <span class="text-sm font-medium transition-colors truncate pointer-events-none leading-tight" style="${nameStyle}">${name}</span>
                    ${moodHTML}
                 </div>
              `;
          };

          // Handle Card Background
          const cardStyle = (data.style && data.style.cardBG && data.style.cardBG !== 'none') ? data.style.cardBG : '';

          if (existing) {
             const currentPfp = existing.getAttribute('data-pfp') || '';
             const currentName = existing.getAttribute('data-name');
             const currentMood = existing.getAttribute('data-mood') || '';
             const currentStyle = existing.getAttribute('data-style') || '{}';
             
             if (currentPfp !== newPfp || currentName !== newName || currentMood !== newMood || currentStyle !== newStyleStr) {
                 existing.innerHTML = generateInner(newPfp, newName, newMood, data.style || {});
                 existing.setAttribute('data-pfp', newPfp);
                 existing.setAttribute('data-name', newName);
                 existing.setAttribute('data-mood', newMood);
                 existing.setAttribute('data-style', newStyleStr);
                 // Update card BG
                 if (cardStyle) existing.setAttribute('style', cardStyle);
                 else existing.removeAttribute('style');
                 
                 try { lucide.createIcons({ root: existing }); } catch(e) { }
             }
          } else {
             const div = document.createElement('div');
             div.className = "flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer group animate-fade-in";
             // Apply Card BG
             if (cardStyle) div.setAttribute('style', cardStyle);

             div.setAttribute('data-uid', data.uid);
             div.setAttribute('data-pfp', newPfp);
             div.setAttribute('data-name', newName);
             div.setAttribute('data-mood', newMood);
             div.setAttribute('data-style', newStyleStr);
             div.onclick = () => openProfile(data.uid); 
             div.innerHTML = generateInner(newPfp, newName, newMood, data.style || {});
             usersList.appendChild(div);
             try { lucide.createIcons({ root: div }); } catch(e) { }
          }
      }

      function startChatListener() {
        const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
        unsubscribeMessages = onSnapshot(q, (snapshot) => {
          if (snapshot.empty) {
             emptyState.style.display = 'flex';
             return;
          }
          emptyState.style.display = 'none';
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") renderMessage(change.doc.data());
          });
          messagesList.scrollTop = messagesList.scrollHeight;
        });
      }

      function renderMessage(data) {
        const div = document.createElement('div');
        div.className = "flex items-start gap-4 px-2 py-1 hover:bg-white/[0.02] transition-colors group animate-fade-in";
        
        let timeString = "";
        if (data.createdAt) {
            const date = data.createdAt.toDate();
            timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
            timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        let avatarHTML = '';
        if (data.photoURL) {
            avatarHTML = `<img src="${data.photoURL}" class="w-10 h-10 mt-1 rounded-full object-cover shrink-0 border border-transparent group-hover:border-indigo-500/20 cursor-pointer" onclick="openProfile('${data.uid}')">`;
        } else {
            avatarHTML = `
            <div class="w-10 h-10 mt-1 rounded-full bg-indigo-500/10 flex items-center justify-center shrink-0 border border-transparent group-hover:border-indigo-500/20 transition-colors cursor-pointer" onclick="openProfile('${data.uid}')">
                <i data-lucide="ghost" class="w-5 h-5 text-indigo-400"></i>
            </div>`;
        }

        let contentHTML = '';
        if (data.imageURL) {
           contentHTML = `
             <div class="mt-1">
               <img src="${data.imageURL}" class="max-w-[250px] md:max-w-sm rounded-xl cursor-zoom-in hover:opacity-90 transition-opacity border border-white/10 shadow-lg" onclick="openLightbox('${data.imageURL}')">
             </div>
           `;
        } else {
           // Parse styles for message text
           let textStyle = `font-family: ${data.style?.message?.font || 'Inter'};`;
           const sObj = data.style?.message || {};
           
           if (sObj.colorType === 'solid') {
               textStyle += `color: ${sObj.value};`;
           } else if (sObj.colorType === 'gradient') {
               textStyle += `background: ${sObj.value}; -webkit-background-clip: text; color: transparent; display: inline-block;`;
           } else if (sObj.colorType === 'neon') {
               textStyle += `color: #fff; text-shadow: 0 0 5px ${sObj.value}, 0 0 10px ${sObj.value};`;
           } else {
               textStyle += `color: #cbd5e1;`;
           }

           contentHTML = `<p class="text-[15px] leading-normal break-words whitespace-pre-wrap" style="${textStyle}">${data.text}</p>`;
        }

        // Parse styles for Username
        let nameStyle = `font-family: ${data.style?.username?.font || 'Inter'};`;
        const uObj = data.style?.username || {};
        
        if (uObj.colorType === 'solid') {
            nameStyle += `color: ${uObj.value};`;
        } else if (uObj.colorType === 'gradient') {
            nameStyle += `background: ${uObj.value}; -webkit-background-clip: text; color: transparent; display: inline-block;`;
        } else if (uObj.colorType === 'neon') {
            nameStyle += `color: #fff; text-shadow: 0 0 5px ${uObj.value}, 0 0 10px ${uObj.value};`;
        } else {
            nameStyle += `color: #e2e8f0;`;
        }

        div.innerHTML = `
          ${avatarHTML}
          <div class="flex flex-col min-w-0 flex-1">
            <div class="flex items-baseline gap-2">
               <span class="font-bold hover:underline cursor-pointer" style="${nameStyle}" onclick="openProfile('${data.uid}')">${data.displayName}</span>
               <span class="text-[10px] text-slate-600 group-hover:text-slate-500 transition-colors">${timeString}</span>
            </div>
            ${contentHTML}
          </div>
        `;
        messagesList.appendChild(div);
        lucide.createIcons();
      }

      authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = emailInput.value;
        const password = passwordInput.value;
        const username = usernameInput.value;
        
        submitBtn.disabled = true;
        btnText.classList.add('hidden');
        btnIcon.classList.add('hidden');
        btnLoader.classList.remove('hidden');
        authError.classList.add('hidden');

        try {
          if (isLogin) {
            await signInWithEmailAndPassword(auth, email, password);
          } else {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            if (username) {
               await updateProfile(userCredential.user, { displayName: username });
            }
            await setDoc(doc(db, "users", userCredential.user.uid), {
                coins: 10000,
                gems: 10000,
                likes: 0,
                likedBy: [],
                displayName: username || email.split('@')[0],
                photoURL: null,
                mood: null,
                bio: "",
                style: currentUserStyle,
                createdAt: serverTimestamp()
            });
          }
        } catch (error) {
          console.error(error);
          let errorMsg = "The spirits rejected your request.";
          if (error.code === 'auth/invalid-email') errorMsg = "That spectral email is invalid.";
          if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') errorMsg = "Unknown soul or wrong glyph.";
          if (error.code === 'auth/email-already-in-use') errorMsg = "That vessel is already occupied.";
          if (error.code === 'auth/weak-password') errorMsg = "Your glyph is too weak.";
          authError.textContent = errorMsg;
          authError.classList.remove('hidden');
        } finally {
          submitBtn.disabled = false;
          btnText.classList.remove('hidden');
          btnIcon.classList.remove('hidden');
          btnLoader.classList.add('hidden');
        }
      });

      messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        const user = auth.currentUser;
        if (!text || !user) return;
        try {
          messageInput.value = ''; 
          await addDoc(collection(db, "messages"), {
            text: text,
            uid: user.uid,
            displayName: user.displayName || user.email.split('@')[0],
            photoURL: currentUserPfp || null,
            style: currentUserStyle, // Add style
            createdAt: serverTimestamp()
          });
        } catch (error) {
          console.error("Error sending message:", error);
          alert("Failed to send message into the void.");
        }
      });

      logoutBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if(user) {
            try { await deleteDoc(doc(db, "online", user.uid)); } catch(e) {}
        }
        signOut(auth);
      });

    </script>
  </body>
</html>
